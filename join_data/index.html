
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Formation PostGIS">
      
      
      
        <meta name="author" content="3Liz">
      
      
        <link rel="canonical" href="https://docs.3liz.org/formation-postgis/join_data/">
      
      <link rel="icon" href="../logo.svg">
      <meta name="generator" content="mkdocs-1.2.2, mkdocs-material-7.1.11">
    
    
      
        <title>Jointures - Formation PostGIS</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.3754935a.min.css">
      
        
        <link rel="stylesheet" href="../assets/stylesheets/palette.f1a3b89f.min.css">
        
          
          
          <meta name="theme-color" content="#4cae4f">
        
      
    
    
    
      
    
    
    
      <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.1.1/styles/default.min.css">
    
    
      


    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="green" data-md-color-accent="deep-orange">
  
    
    <script>function __prefix(e){return new URL("..",location).pathname+"."+e}function __get(e,t=localStorage){return JSON.parse(t.getItem(__prefix(e)))}</script>
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#les-jointures" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="Formation PostGIS" class="md-header__button md-logo" aria-label="Formation PostGIS" data-md-component="logo">
      
  <img src="../logo.svg" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Formation PostGIS
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Jointures
            
          </span>
        </div>
      </div>
    </div>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
      </label>
      
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" data-md-state="active" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </label>
      <button type="reset" class="md-search__icon md-icon" aria-label="Clear" tabindex="-1">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg>
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        
<a href="https://github.com/3liz/formation-postgis/" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 480 512"><path d="M186.1 328.7c0 20.9-10.9 55.1-36.7 55.1s-36.7-34.2-36.7-55.1 10.9-55.1 36.7-55.1 36.7 34.2 36.7 55.1zM480 278.2c0 31.9-3.2 65.7-17.5 95-37.9 76.6-142.1 74.8-216.7 74.8-75.8 0-186.2 2.7-225.6-74.8-14.6-29-20.2-63.1-20.2-95 0-41.9 13.9-81.5 41.5-113.6-5.2-15.8-7.7-32.4-7.7-48.8 0-21.5 4.9-32.3 14.6-51.8 45.3 0 74.3 9 108.8 36 29-6.9 58.8-10 88.7-10 27 0 54.2 2.9 80.4 9.2 34-26.7 63-35.2 107.8-35.2 9.8 19.5 14.6 30.3 14.6 51.8 0 16.4-2.6 32.7-7.7 48.2 27.5 32.4 39 72.3 39 114.2zm-64.3 50.5c0-43.9-26.7-82.6-73.5-82.6-18.9 0-37 3.4-56 6-14.9 2.3-29.8 3.2-45.1 3.2-15.2 0-30.1-.9-45.1-3.2-18.7-2.6-37-6-56-6-46.8 0-73.5 38.7-73.5 82.6 0 87.8 80.4 101.3 150.4 101.3h48.2c70.3 0 150.6-13.4 150.6-101.3zm-82.6-55.1c-25.8 0-36.7 34.2-36.7 55.1s10.9 55.1 36.7 55.1 36.7-34.2 36.7-55.1-10.9-55.1-36.7-55.1z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
      </div>
    
  </nav>
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="Formation PostGIS" class="md-nav__button md-logo" aria-label="Formation PostGIS" data-md-component="logo">
      
  <img src="../logo.svg" alt="logo">

    </a>
    Formation PostGIS
  </label>
  
    <div class="md-nav__source">
      
<a href="https://github.com/3liz/formation-postgis/" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 480 512"><path d="M186.1 328.7c0 20.9-10.9 55.1-36.7 55.1s-36.7-34.2-36.7-55.1 10.9-55.1 36.7-55.1 36.7 34.2 36.7 55.1zM480 278.2c0 31.9-3.2 65.7-17.5 95-37.9 76.6-142.1 74.8-216.7 74.8-75.8 0-186.2 2.7-225.6-74.8-14.6-29-20.2-63.1-20.2-95 0-41.9 13.9-81.5 41.5-113.6-5.2-15.8-7.7-32.4-7.7-48.8 0-21.5 4.9-32.3 14.6-51.8 45.3 0 74.3 9 108.8 36 29-6.9 58.8-10 88.7-10 27 0 54.2 2.9 80.4 9.2 34-26.7 63-35.2 107.8-35.2 9.8 19.5 14.6 30.3 14.6 51.8 0 16.4-2.6 32.7-7.7 48.2 27.5 32.4 39 72.3 39 114.2zm-64.3 50.5c0-43.9-26.7-82.6-73.5-82.6-18.9 0-37 3.4-56 6-14.9 2.3-29.8 3.2-45.1 3.2-15.2 0-30.1-.9-45.1-3.2-18.7-2.6-37-6-56-6-46.8 0-73.5 38.7-73.5 82.6 0 87.8 80.4 101.3 150.4 101.3h48.2c70.3 0 150.6-13.4 150.6-101.3zm-82.6-55.1c-25.8 0-36.7 34.2-36.7 55.1s10.9 55.1 36.7 55.1 36.7-34.2 36.7-55.1-10.9-55.1-36.7-55.1z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../" class="md-nav__link">
        docs.3liz.org
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href=".." class="md-nav__link">
        Accueil
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../links_and_data/" class="md-nav__link">
        Liens et données
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../postgresql_in_qgis/" class="md-nav__link">
        Gestion des données
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../import_data/" class="md-nav__link">
        Import des données
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../sql_select/" class="md-nav__link">
        Sélection
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../perform_calculation/" class="md-nav__link">
        Calcul & Fonctions
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../filter_data/" class="md-nav__link">
        Filtrer
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../group_data/" class="md-nav__link">
        Regrouper
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../union/" class="md-nav__link">
        Rassembler
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../save_queries/" class="md-nav__link">
        Enregistrer
      </a>
    </li>
  

    
      
      
      

  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          Jointures
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        Jointures
      </a>
      
        
<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#les-jointures-attributaires" class="md-nav__link">
    Les jointures attributaires
  </a>
  
    <nav class="md-nav" aria-label="Les jointures attributaires">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#exemple-1-zonages-et-communes" class="md-nav__link">
    Exemple 1: zonages et communes
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#exemple-2-observations-et-communes" class="md-nav__link">
    Exemple 2: observations et communes
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#les-jointures-spatiales" class="md-nav__link">
    Les jointures spatiales
  </a>
  
    <nav class="md-nav" aria-label="Les jointures spatiales">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#joindre-des-points-avec-des-polygones" class="md-nav__link">
    Joindre des points avec des polygones
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#joindre-des-lignes-avec-des-polygones" class="md-nav__link">
    Joindre des lignes avec des polygones
  </a>
  
    <nav class="md-nav" aria-label="Joindre des lignes avec des polygones">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#jointure-spatiale-simple-entre-les-geometries-brutes" class="md-nav__link">
    Jointure spatiale simple entre les géométries brutes
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#jointure-spatiale-entre-le-centroide-des-chemins-et-la-geometrie-des-communes" class="md-nav__link">
    Jointure spatiale entre le centroide des chemins et la géométrie des communes
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#utilisation-dune-jointure-left-pour-garder-les-communes-sans-chemins" class="md-nav__link">
    Utilisation d'une jointure LEFT pour garder les communes sans chemins
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#affiner-le-resultat-en-decoupant-les-chemins" class="md-nav__link">
    Affiner le résultat en découpant les chemins
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#joindre-des-polygones-avec-des-polygones" class="md-nav__link">
    Joindre des polygones avec des polygones
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#faire-un-rapport-des-surfaces-intersectees-de-zonages-sur-une-table-principale" class="md-nav__link">
    Faire un rapport des surfaces intersectées de zonages sur une table principale
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#distances-et-tampons-entre-couches" class="md-nav__link">
    Distances et tampons entre couches
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../merge_geometries/" class="md-nav__link">
        Fusionner
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../triggers/" class="md-nav__link">
        Triggers
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../validate_geometries/" class="md-nav__link">
        Correction géométries
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../check_topology/" class="md-nav__link">
        Topologie
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../utils/" class="md-nav__link">
        Fonctions utiles
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../grant/" class="md-nav__link">
        Droits
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../fdw/" class="md-nav__link">
        Données externes
      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#les-jointures-attributaires" class="md-nav__link">
    Les jointures attributaires
  </a>
  
    <nav class="md-nav" aria-label="Les jointures attributaires">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#exemple-1-zonages-et-communes" class="md-nav__link">
    Exemple 1: zonages et communes
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#exemple-2-observations-et-communes" class="md-nav__link">
    Exemple 2: observations et communes
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#les-jointures-spatiales" class="md-nav__link">
    Les jointures spatiales
  </a>
  
    <nav class="md-nav" aria-label="Les jointures spatiales">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#joindre-des-points-avec-des-polygones" class="md-nav__link">
    Joindre des points avec des polygones
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#joindre-des-lignes-avec-des-polygones" class="md-nav__link">
    Joindre des lignes avec des polygones
  </a>
  
    <nav class="md-nav" aria-label="Joindre des lignes avec des polygones">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#jointure-spatiale-simple-entre-les-geometries-brutes" class="md-nav__link">
    Jointure spatiale simple entre les géométries brutes
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#jointure-spatiale-entre-le-centroide-des-chemins-et-la-geometrie-des-communes" class="md-nav__link">
    Jointure spatiale entre le centroide des chemins et la géométrie des communes
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#utilisation-dune-jointure-left-pour-garder-les-communes-sans-chemins" class="md-nav__link">
    Utilisation d'une jointure LEFT pour garder les communes sans chemins
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#affiner-le-resultat-en-decoupant-les-chemins" class="md-nav__link">
    Affiner le résultat en découpant les chemins
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#joindre-des-polygones-avec-des-polygones" class="md-nav__link">
    Joindre des polygones avec des polygones
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#faire-un-rapport-des-surfaces-intersectees-de-zonages-sur-une-table-principale" class="md-nav__link">
    Faire un rapport des surfaces intersectées de zonages sur une table principale
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#distances-et-tampons-entre-couches" class="md-nav__link">
    Distances et tampons entre couches
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content" data-md-component="content">
            <article class="md-content__inner md-typeset">
              
                
                  <a href="https://github.com/3liz/formation-postgis/edit/master/docs/join_data.md" title="Edit this page" class="md-content__button md-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20.71 7.04c.39-.39.39-1.04 0-1.41l-2.34-2.34c-.37-.39-1.02-.39-1.41 0l-1.84 1.83 3.75 3.75M3 17.25V21h3.75L17.81 9.93l-3.75-3.75L3 17.25z"/></svg>
                  </a>
                
                
                <h1 id="les-jointures">Les jointures<a class="headerlink" href="#les-jointures" title="Permanent link">#</a></h1>
<p>Les jointures permettent de récupérer des données en relation les unes par rapport aux autres.</p>
<h2 id="les-jointures-attributaires">Les jointures attributaires<a class="headerlink" href="#les-jointures-attributaires" title="Permanent link">#</a></h2>
<p>La condition de jointure est faite sur des champs non géométriques. Par exemple une égalité (code, identifiant).</p>
<h3 id="exemple-1-zonages-et-communes">Exemple 1: zonages et communes<a class="headerlink" href="#exemple-1-zonages-et-communes" title="Permanent link">#</a></h3>
<p>Récupération des informations de la commune pour chaque zonage</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span>
<span class="normal">6</span>
<span class="normal">7</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="c1">-- Jointure attributaire: récupération du nom de la commune pour chacun des zonages</span>
<span class="k">SELECT</span> <span class="n">z</span><span class="p">.</span><span class="o">*</span><span class="p">,</span> <span class="k">c</span><span class="p">.</span><span class="n">nom</span>
<span class="k">FROM</span> <span class="n">z_formation</span><span class="p">.</span><span class="n">zone_urba</span> <span class="k">AS</span> <span class="n">z</span>
<span class="k">JOIN</span> <span class="n">z_formation</span><span class="p">.</span><span class="n">commune</span> <span class="k">AS</span> <span class="k">c</span> <span class="k">ON</span> <span class="n">z</span><span class="p">.</span><span class="n">insee</span> <span class="o">=</span> <span class="k">c</span><span class="p">.</span><span class="n">code_insee</span>
<span class="c1">-- IMPORTANT: ne pas oublier le ON cad le critère de jointure,</span>
<span class="c1">-- sous peine de &quot;produit cartésien&quot; (calcul couteux de tous les possibles)</span>
<span class="p">;</span>
</code></pre></div>
</td></tr></table>
<p>Il est souvent intéressant, pour des données volumineuses, de <strong>créer un index sur le champ de jointure</strong> (par exemple ici sur les champs insee et ccocom.</p>
<h3 id="exemple-2-observations-et-communes">Exemple 2: observations et communes<a class="headerlink" href="#exemple-2-observations-et-communes" title="Permanent link">#</a></h3>
<ul>
<li>On crée une table de points qui contiendra des observations</li>
</ul>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="c1">-- création</span>
<span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">z_formation</span><span class="p">.</span><span class="n">observation</span> <span class="p">(</span>
    <span class="n">id</span> <span class="nb">serial</span> <span class="k">NOT</span> <span class="k">NULL</span> <span class="k">PRIMARY</span> <span class="k">KEY</span><span class="p">,</span>
    <span class="nb">date</span> <span class="nb">date</span> <span class="k">DEFAULT</span> <span class="p">(</span><span class="n">now</span><span class="p">())::</span><span class="nb">date</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
    <span class="n">description</span> <span class="nb">text</span><span class="p">,</span>
    <span class="n">geom</span> <span class="k">public</span><span class="p">.</span><span class="n">geometry</span><span class="p">(</span><span class="n">Point</span><span class="p">,</span><span class="mi">2154</span><span class="p">),</span>
    <span class="n">code_insee</span> <span class="nb">character</span> <span class="nb">varying</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
<span class="p">);</span>
<span class="k">CREATE</span> <span class="k">INDEX</span> <span class="n">sidx_observation_geom</span> <span class="k">ON</span> <span class="n">z_formation</span><span class="p">.</span><span class="n">observation</span> <span class="k">USING</span> <span class="n">gist</span> <span class="p">(</span><span class="n">geom</span><span class="p">);</span>

<span class="c1">-- on y met des données</span>
<span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">z_formation</span><span class="p">.</span><span class="n">observation</span> <span class="k">VALUES</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;2020-07-08&#39;</span><span class="p">,</span> <span class="s1">&#39;un&#39;</span><span class="p">,</span> <span class="s1">&#39;01010000206A080000D636D95AFB832141279BD2C8FEA65A41&#39;</span><span class="p">,</span> <span class="s1">&#39;76618&#39;</span><span class="p">);</span>
<span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">z_formation</span><span class="p">.</span><span class="n">observation</span> <span class="k">VALUES</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;2020-07-08&#39;</span><span class="p">,</span> <span class="s1">&#39;deux&#39;</span><span class="p">,</span> <span class="s1">&#39;01010000206A08000010248E173E37224156920AEA21525A41&#39;</span><span class="p">,</span> <span class="s1">&#39;27213&#39;</span><span class="p">);</span>
<span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">z_formation</span><span class="p">.</span><span class="n">observation</span> <span class="k">VALUES</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="s1">&#39;2020-07-08&#39;</span><span class="p">,</span> <span class="s1">&#39;trois&#39;</span><span class="p">,</span> <span class="s1">&#39;01010000206A08000018BF3048EA112341183933F6CC885A41&#39;</span><span class="p">,</span> <span class="k">NULL</span><span class="p">);</span>
</code></pre></div>
</td></tr></table>
<p>On fait une jointure attributaire entre les points des observations et les communes</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="k">SELECT</span>
    <span class="c1">-- tous les champs de la table observation</span>
    <span class="n">o</span><span class="p">.</span><span class="o">*</span><span class="p">,</span>
    <span class="c1">-- le nom de la commune</span>
    <span class="k">c</span><span class="p">.</span><span class="n">nom</span><span class="p">,</span>
    <span class="c1">-- l&#39;aire entière en hectares</span>
    <span class="n">ST_area</span><span class="p">(</span><span class="k">c</span><span class="p">.</span><span class="n">geom</span><span class="p">)::</span><span class="nb">integer</span><span class="o">/</span><span class="mi">10000</span> <span class="k">AS</span> <span class="n">surface_commune</span>
<span class="k">FROM</span> <span class="n">z_formation</span><span class="p">.</span><span class="n">observation</span> <span class="k">AS</span> <span class="n">o</span>
<span class="k">JOIN</span> <span class="n">z_formation</span><span class="p">.</span><span class="n">commune</span> <span class="k">AS</span> <span class="k">c</span> <span class="k">ON</span> <span class="n">o</span><span class="p">.</span><span class="n">code_insee</span> <span class="o">=</span> <span class="k">c</span><span class="p">.</span><span class="n">code_insee</span>
<span class="k">WHERE</span> <span class="k">True</span>
</code></pre></div>
</td></tr></table>
<p>Résultat:</p>
<table>
<thead>
<tr>
<th>id</th>
<th>date</th>
<th>description</th>
<th>geom</th>
<th>code_insee</th>
<th>nom</th>
<th>surface_commune</th>
</tr>
</thead>
<tbody>
<tr>
<td>2</td>
<td>2020-07-08</td>
<td>deux</td>
<td>....</td>
<td>27213</td>
<td>Vexin-sur-Epte</td>
<td>11434</td>
</tr>
<tr>
<td>1</td>
<td>2020-07-08</td>
<td>un</td>
<td>....</td>
<td>76618</td>
<td>Petit-Caux</td>
<td>9243</td>
</tr>
</tbody>
</table>
<p>On ne récupère ici que 2 lignes alors qu'il y a bien 3 observations dans la table.</p>
<p>Pour récupérer les 3 lignes, on doit faire une jointure LEFT. On peut utiliser un <code>CASE WHEN</code> pour tester si la commune est trouvée sous chaque point</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span>
<span class="normal">6</span>
<span class="normal">7</span>
<span class="normal">8</span>
<span class="normal">9</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="k">SELECT</span>
    <span class="n">o</span><span class="p">.</span><span class="o">*</span><span class="p">,</span> <span class="k">c</span><span class="p">.</span><span class="n">nom</span><span class="p">,</span> <span class="n">ST_area</span><span class="p">(</span><span class="k">c</span><span class="p">.</span><span class="n">geom</span><span class="p">)::</span><span class="nb">integer</span><span class="o">/</span><span class="mi">10000</span> <span class="k">AS</span> <span class="n">surface_commune</span><span class="p">,</span>
    <span class="k">CASE</span>
        <span class="k">WHEN</span> <span class="k">c</span><span class="p">.</span><span class="n">code_insee</span> <span class="k">IS</span> <span class="k">NULL</span> <span class="k">THEN</span> <span class="s1">&#39;pas de commune&#39;</span>
        <span class="k">ELSE</span> <span class="s1">&#39;ok&#39;</span>
    <span class="k">END</span> <span class="k">AS</span> <span class="n">test_commune</span>
<span class="k">FROM</span> <span class="n">z_formation</span><span class="p">.</span><span class="n">observation</span> <span class="k">AS</span> <span class="n">o</span>
<span class="k">LEFT</span> <span class="k">JOIN</span> <span class="n">z_formation</span><span class="p">.</span><span class="n">commune</span> <span class="k">AS</span> <span class="k">c</span> <span class="k">ON</span> <span class="n">o</span><span class="p">.</span><span class="n">code_insee</span> <span class="o">=</span> <span class="k">c</span><span class="p">.</span><span class="n">code_insee</span>
<span class="k">WHERE</span> <span class="k">True</span>
</code></pre></div>
</td></tr></table>
<p>Résultat</p>
<table>
<thead>
<tr>
<th>id</th>
<th>date</th>
<th>description</th>
<th>geom</th>
<th>code_insee</th>
<th>nom</th>
<th>surface_commune</th>
<th>test_commune</th>
</tr>
</thead>
<tbody>
<tr>
<td>2</td>
<td>2020-07-08</td>
<td>deux</td>
<td>....</td>
<td>27213</td>
<td>Vexin-sur-Epte</td>
<td>11434</td>
<td>ok</td>
</tr>
<tr>
<td>1</td>
<td>2020-07-08</td>
<td>un</td>
<td>....</td>
<td>76618</td>
<td>Petit-Caux</td>
<td>9243</td>
<td>ok</td>
</tr>
<tr>
<td>3</td>
<td>2020-07-08</td>
<td>trois</td>
<td>....</td>
<td>Null</td>
<td>Null</td>
<td>Null</td>
<td>pas de commune</td>
</tr>
</tbody>
</table>
<h2 id="les-jointures-spatiales">Les jointures spatiales<a class="headerlink" href="#les-jointures-spatiales" title="Permanent link">#</a></h2>
<p>Le critère de jointure peut être une <strong>condition spatiale</strong>. On réalise souvent une jointure par <strong>intersection</strong> ou par <strong>proximité</strong>.</p>
<h3 id="joindre-des-points-avec-des-polygones">Joindre des points avec des polygones<a class="headerlink" href="#joindre-des-points-avec-des-polygones" title="Permanent link">#</a></h3>
<p>Un exemple classique de récupération des données de la table commune (nom, etc.) depuis une table de points.</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span>
<span class="normal">6</span>
<span class="normal">7</span>
<span class="normal">8</span>
<span class="normal">9</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="c1">-- Pour chaque lieu-dit, on veut le nom de la commune</span>
<span class="k">SELECT</span>
<span class="n">l</span><span class="p">.</span><span class="n">id_lieu_dit_habite</span><span class="p">,</span> <span class="n">l</span><span class="p">.</span><span class="n">nom</span><span class="p">,</span>
<span class="k">c</span><span class="p">.</span><span class="n">nom</span> <span class="k">AS</span> <span class="n">nom_commune</span><span class="p">,</span> <span class="k">c</span><span class="p">.</span><span class="n">code_insee</span><span class="p">,</span>
<span class="n">l</span><span class="p">.</span><span class="n">geom</span>
<span class="k">FROM</span> <span class="ss">&quot;z_formation&quot;</span><span class="p">.</span><span class="n">lieu_dit_habite</span> <span class="k">AS</span> <span class="n">l</span>
<span class="k">JOIN</span> <span class="ss">&quot;z_formation&quot;</span><span class="p">.</span><span class="n">commune</span> <span class="k">AS</span> <span class="k">c</span>
        <span class="k">ON</span> <span class="n">st_intersects</span><span class="p">(</span><span class="k">c</span><span class="p">.</span><span class="n">geom</span><span class="p">,</span> <span class="n">l</span><span class="p">.</span><span class="n">geom</span><span class="p">)</span>
<span class="k">ORDER</span> <span class="k">BY</span> <span class="n">l</span><span class="p">.</span><span class="n">nom</span>
</code></pre></div>
</td></tr></table>
<table>
<thead>
<tr>
<th>id_lieu_dit_habite</th>
<th>nom</th>
<th>nom_commune</th>
<th>code_insee</th>
<th>geom</th>
</tr>
</thead>
<tbody>
<tr>
<td>58</td>
<td>Abbaye du Valasse</td>
<td>Gruchet-le-Valasse</td>
<td>76329</td>
<td>....</td>
</tr>
<tr>
<td>1024</td>
<td>Ablemont</td>
<td>Bacqueville-en-Caux</td>
<td>76051</td>
<td>....</td>
</tr>
<tr>
<td>1043</td>
<td>Agranville</td>
<td>Douvrend</td>
<td>76220</td>
<td>....</td>
</tr>
<tr>
<td>1377</td>
<td>All des Artisans</td>
<td>Mesnils-sur-Iton</td>
<td>27198</td>
<td>....</td>
</tr>
<tr>
<td>1801</td>
<td>Allée des Maronniers</td>
<td>Heudebouville</td>
<td>27332</td>
<td>....</td>
</tr>
<tr>
<td>1293</td>
<td>Alliquerville</td>
<td>Trouville</td>
<td>76715</td>
<td>....</td>
</tr>
<tr>
<td>507</td>
<td>Alventot</td>
<td>Sainte-Hélène-Bondeville</td>
<td>76587</td>
<td>....</td>
</tr>
<tr>
<td>555</td>
<td>Alvinbuc</td>
<td>Veauville-lès-Baons</td>
<td>76729</td>
<td>....</td>
</tr>
<tr>
<td>69</td>
<td>Ancien hôtel de ville</td>
<td>Rouen</td>
<td>76540</td>
<td>....</td>
</tr>
</tbody>
</table>
<p>On peut facilement inverser la table principale pour afficher les lignes ordonnées par commune.</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span>
<span class="normal">6</span>
<span class="normal">7</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="k">SELECT</span>
<span class="k">c</span><span class="p">.</span><span class="n">nom</span><span class="p">,</span> <span class="k">c</span><span class="p">.</span><span class="n">code_insee</span><span class="p">,</span>
<span class="n">l</span><span class="p">.</span><span class="n">id_lieu_dit_habite</span><span class="p">,</span> <span class="n">l</span><span class="p">.</span><span class="n">nom</span>
<span class="k">FROM</span> <span class="ss">&quot;z_formation&quot;</span><span class="p">.</span><span class="n">commune</span> <span class="k">AS</span> <span class="k">c</span>
<span class="k">JOIN</span> <span class="ss">&quot;z_formation&quot;</span><span class="p">.</span><span class="n">lieu_dit_habite</span> <span class="k">AS</span> <span class="n">l</span>
        <span class="k">ON</span> <span class="n">st_intersects</span><span class="p">(</span><span class="k">c</span><span class="p">.</span><span class="n">geom</span><span class="p">,</span> <span class="n">l</span><span class="p">.</span><span class="n">geom</span><span class="p">)</span>
<span class="k">ORDER</span> <span class="k">BY</span> <span class="k">c</span><span class="p">.</span><span class="n">nom</span>
</code></pre></div>
</td></tr></table>
<table>
<thead>
<tr>
<th>nom</th>
<th>code_insee</th>
<th>id_lieu_dit_habite</th>
<th>nom</th>
</tr>
</thead>
<tbody>
<tr>
<td>Aclou</td>
<td>27001</td>
<td>107</td>
<td>Manoir de la Haule</td>
</tr>
<tr>
<td>Acquigny</td>
<td>27003</td>
<td>106</td>
<td>Manoir de Becdal</td>
</tr>
<tr>
<td>Ailly</td>
<td>27005</td>
<td>596</td>
<td>Quaizes</td>
</tr>
<tr>
<td>Ailly</td>
<td>27005</td>
<td>595</td>
<td>Ingremare</td>
</tr>
<tr>
<td>Ailly</td>
<td>27005</td>
<td>594</td>
<td>Gruchet</td>
</tr>
<tr>
<td>Alizay</td>
<td>27008</td>
<td>667</td>
<td>Le Solitaire</td>
</tr>
<tr>
<td>Ambenay</td>
<td>27009</td>
<td>204</td>
<td>Les Siaules</td>
</tr>
<tr>
<td>Ambenay</td>
<td>27009</td>
<td>201</td>
<td>Les Renardieres</td>
</tr>
<tr>
<td>Ambenay</td>
<td>27009</td>
<td>202</td>
<td>Le Culoron</td>
</tr>
</tbody>
</table>
<p>On a plusieurs lignes par commune, autant que de lieux-dits pour cette commune. Par contre, comme ce n'est pas une jointure LEFT, on ne trouve que des résultats pour les communes qui ont des lieux-dits.</p>
<p>On pourrait aussi faire des statistiques, en regroupant par les champs de la table principale, ici les communes.</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="k">SELECT</span>
<span class="k">c</span><span class="p">.</span><span class="n">nom</span><span class="p">,</span> <span class="k">c</span><span class="p">.</span><span class="n">code_insee</span><span class="p">,</span>
<span class="k">count</span><span class="p">(</span><span class="n">l</span><span class="p">.</span><span class="n">id_lieu_dit_habite</span><span class="p">)</span> <span class="k">AS</span> <span class="n">nb_lieu_dit</span><span class="p">,</span>
<span class="k">c</span><span class="p">.</span><span class="n">geom</span>
<span class="k">FROM</span> <span class="ss">&quot;z_formation&quot;</span><span class="p">.</span><span class="n">commune</span> <span class="k">AS</span> <span class="k">c</span>
<span class="k">JOIN</span> <span class="ss">&quot;z_formation&quot;</span><span class="p">.</span><span class="n">lieu_dit_habite</span> <span class="k">AS</span> <span class="n">l</span>
        <span class="k">ON</span> <span class="n">st_intersects</span><span class="p">(</span><span class="k">c</span><span class="p">.</span><span class="n">geom</span><span class="p">,</span> <span class="n">l</span><span class="p">.</span><span class="n">geom</span><span class="p">)</span>
<span class="k">GROUP</span> <span class="k">BY</span> <span class="k">c</span><span class="p">.</span><span class="n">nom</span><span class="p">,</span> <span class="k">c</span><span class="p">.</span><span class="n">code_insee</span><span class="p">,</span> <span class="k">c</span><span class="p">.</span><span class="n">geom</span>
<span class="k">ORDER</span> <span class="k">BY</span> <span class="n">nb_lieu_dit</span> <span class="k">DESC</span>
<span class="k">LIMIT</span> <span class="mi">10</span>
</code></pre></div>
</td></tr></table>
<table>
<thead>
<tr>
<th>nom</th>
<th>code_insee</th>
<th>nb_lieu_dit</th>
<th>geom</th>
</tr>
</thead>
<tbody>
<tr>
<td>Heudebouville</td>
<td>27332</td>
<td>61</td>
<td>....</td>
</tr>
<tr>
<td>Mesnils-sur-Iton</td>
<td>27198</td>
<td>52</td>
<td>....</td>
</tr>
<tr>
<td>Rouen</td>
<td>76540</td>
<td>20</td>
<td>....</td>
</tr>
<tr>
<td>Saint-Saëns</td>
<td>76648</td>
<td>19</td>
<td>....</td>
</tr>
<tr>
<td>Les Grandes-Ventes</td>
<td>76321</td>
<td>19</td>
<td>....</td>
</tr>
<tr>
<td>Mesnil-en-Ouche</td>
<td>27049</td>
<td>18</td>
<td>....</td>
</tr>
<tr>
<td>Quincampoix</td>
<td>76517</td>
<td>18</td>
<td>....</td>
</tr>
</tbody>
</table>
<h3 id="joindre-des-lignes-avec-des-polygones">Joindre des lignes avec des polygones<a class="headerlink" href="#joindre-des-lignes-avec-des-polygones" title="Permanent link">#</a></h3>
<p>Récupérer le code commune de chaque chemin, par <strong>intersection entre le chemin et la commune</strong>.</p>
<h4 id="jointure-spatiale-simple-entre-les-geometries-brutes">Jointure spatiale simple entre les géométries brutes<a class="headerlink" href="#jointure-spatiale-simple-entre-les-geometries-brutes" title="Permanent link">#</a></h4>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span>
<span class="normal">6</span>
<span class="normal">7</span>
<span class="normal">8</span>
<span class="normal">9</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="c1">-- Ici, on peut récupérer plusieurs fois le même chemin</span>
<span class="c1">-- s&#39;il passe par plusieurs communes</span>
<span class="k">SELECT</span>
<span class="n">v</span><span class="p">.</span><span class="o">*</span><span class="p">,</span>
<span class="k">c</span><span class="p">.</span><span class="n">nom</span><span class="p">,</span> <span class="k">c</span><span class="p">.</span><span class="n">code_insee</span>
<span class="k">FROM</span> <span class="ss">&quot;z_formation&quot;</span><span class="p">.</span><span class="n">chemin</span> <span class="k">AS</span> <span class="n">v</span>
<span class="k">JOIN</span> <span class="ss">&quot;z_formation&quot;</span><span class="p">.</span><span class="n">commune</span> <span class="k">AS</span> <span class="k">c</span>
        <span class="k">ON</span> <span class="n">ST_Intersects</span><span class="p">(</span><span class="n">v</span><span class="p">.</span><span class="n">geom</span><span class="p">,</span> <span class="k">c</span><span class="p">.</span><span class="n">geom</span><span class="p">)</span>
<span class="k">ORDER</span> <span class="k">BY</span> <span class="n">id_chemin</span><span class="p">,</span> <span class="n">nom</span>
</code></pre></div>
</td></tr></table>
<p>Cela peut renvoyer plusieurs lignes par chemin, car chaque chemin peut passer par plusieurs communes.</p>
<h4 id="jointure-spatiale-entre-le-centroide-des-chemins-et-la-geometrie-des-communes">Jointure spatiale entre le centroide des chemins et la géométrie des communes<a class="headerlink" href="#jointure-spatiale-entre-le-centroide-des-chemins-et-la-geometrie-des-communes" title="Permanent link">#</a></h4>
<p>On peut utiliser le <strong>centroide de chaque chemin</strong> pour avoir un seul objet par chemin comme résultat.</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="c1">-- création de l&#39;index</span>
<span class="k">CREATE</span> <span class="k">INDEX</span> <span class="k">ON</span> <span class="n">z_formation</span><span class="p">.</span><span class="n">chemin</span> <span class="k">USING</span> <span class="n">gist</span> <span class="p">(</span><span class="n">ST_Centroid</span><span class="p">(</span><span class="n">geom</span><span class="p">));</span>
<span class="c1">-- Jointure spatiale</span>
<span class="c1">-- On ne veut qu&#39;une seule ligne par chemin</span>
<span class="c1">-- Donc on fait l&#39;intersection entre le centroïde des chemins (pour avoir un point) et les communes</span>
<span class="k">SELECT</span>
<span class="n">v</span><span class="p">.</span><span class="o">*</span><span class="p">,</span>
<span class="k">c</span><span class="p">.</span><span class="n">nom</span><span class="p">,</span> <span class="k">c</span><span class="p">.</span><span class="n">code_insee</span>
<span class="k">FROM</span> <span class="ss">&quot;z_formation&quot;</span><span class="p">.</span><span class="n">chemin</span> <span class="k">AS</span> <span class="n">v</span>
<span class="k">JOIN</span> <span class="ss">&quot;z_formation&quot;</span><span class="p">.</span><span class="n">commune</span> <span class="k">AS</span> <span class="k">c</span>
        <span class="k">ON</span> <span class="n">ST_Intersects</span><span class="p">(</span><span class="n">ST_Centroid</span><span class="p">(</span><span class="n">v</span><span class="p">.</span><span class="n">geom</span><span class="p">),</span> <span class="k">c</span><span class="p">.</span><span class="n">geom</span><span class="p">)</span>
</code></pre></div>
</td></tr></table>
<p><strong>NB:</strong> Attention, dans ce cas, l'index spatial sur la géométrie des chemins n'est pas utilisé. C'est pour cela que nous avons créé un index spatial sur ST_Centroid(geom) pour la table des chemins.</p>
<p>A l'inverse, on peut vouloir faire des <strong>statistiques pour chaque commune</strong> via jointure spatiale. Par exemple le nombre de chemins et le total des longueurs par commune.</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code> <span class="c1">-- A l&#39;inverse, on veut récupérer des statistiques par commune</span>
 <span class="c1">-- On veut une ligne par commune, avec des données sur les voies</span>
<span class="k">SELECT</span>
<span class="k">c</span><span class="p">.</span><span class="n">id_commune</span><span class="p">,</span> <span class="k">c</span><span class="p">.</span><span class="n">nom</span><span class="p">,</span> <span class="k">c</span><span class="p">.</span><span class="n">code_insee</span><span class="p">,</span>
<span class="k">count</span><span class="p">(</span><span class="n">v</span><span class="p">.</span><span class="n">id_chemin</span><span class="p">)</span> <span class="k">AS</span> <span class="n">nb_chemin</span><span class="p">,</span>
<span class="k">sum</span><span class="p">(</span><span class="n">st_length</span><span class="p">(</span><span class="n">v</span><span class="p">.</span><span class="n">geom</span><span class="p">))</span> <span class="k">AS</span> <span class="n">somme_longueur_chemins_entiers</span>
<span class="k">FROM</span> <span class="n">z_formation</span><span class="p">.</span><span class="n">commune</span> <span class="k">AS</span> <span class="k">c</span>
<span class="k">JOIN</span> <span class="n">z_formation</span><span class="p">.</span><span class="n">chemin</span> <span class="k">AS</span> <span class="n">v</span>
        <span class="k">ON</span> <span class="n">st_intersects</span><span class="p">(</span><span class="k">c</span><span class="p">.</span><span class="n">geom</span><span class="p">,</span> <span class="n">st_centroid</span><span class="p">(</span><span class="n">v</span><span class="p">.</span><span class="n">geom</span><span class="p">))</span>
<span class="k">GROUP</span> <span class="k">BY</span> <span class="k">c</span><span class="p">.</span><span class="n">id_commune</span><span class="p">,</span> <span class="k">c</span><span class="p">.</span><span class="n">nom</span><span class="p">,</span> <span class="k">c</span><span class="p">.</span><span class="n">code_insee</span>
<span class="p">;</span>
</code></pre></div>
</td></tr></table>
<h4 id="utilisation-dune-jointure-left-pour-garder-les-communes-sans-chemins">Utilisation d'une jointure LEFT pour garder les communes sans chemins<a class="headerlink" href="#utilisation-dune-jointure-left-pour-garder-les-communes-sans-chemins" title="Permanent link">#</a></h4>
<p>La requête précédente ne renvoit pas de lignes pour les communes qui n'ont pas de chemin dont le centroide est dans une commune. C'est une jointure de type <strong>INNER JOIN</strong></p>
<p>Si on veut quand même récupérer ces communes, on fait une jointure <strong>LEFT JOIN</strong>: pour les lignes sans chemins, les champs liés à la table des chemins seront mis à NULL.</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span>
<span class="normal">6</span>
<span class="normal">7</span>
<span class="normal">8</span>
<span class="normal">9</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="k">SELECT</span>
<span class="k">c</span><span class="p">.</span><span class="n">id_commune</span><span class="p">,</span> <span class="k">c</span><span class="p">.</span><span class="n">nom</span><span class="p">,</span> <span class="k">c</span><span class="p">.</span><span class="n">code_insee</span><span class="p">,</span>
<span class="k">count</span><span class="p">(</span><span class="n">v</span><span class="p">.</span><span class="n">id_chemin</span><span class="p">)</span> <span class="k">AS</span> <span class="n">nb_chemin</span><span class="p">,</span>
<span class="k">sum</span><span class="p">(</span><span class="n">st_length</span><span class="p">(</span><span class="n">v</span><span class="p">.</span><span class="n">geom</span><span class="p">))</span> <span class="k">AS</span> <span class="n">somme_longueur_chemins_entiers</span>
<span class="k">FROM</span> <span class="n">z_formation</span><span class="p">.</span><span class="n">commune</span> <span class="k">AS</span> <span class="k">c</span>
<span class="k">LEFT</span> <span class="k">JOIN</span> <span class="n">z_formation</span><span class="p">.</span><span class="n">chemin</span> <span class="k">AS</span> <span class="n">v</span>
        <span class="k">ON</span> <span class="n">st_intersects</span><span class="p">(</span><span class="k">c</span><span class="p">.</span><span class="n">geom</span><span class="p">,</span> <span class="n">st_centroid</span><span class="p">(</span><span class="n">v</span><span class="p">.</span><span class="n">geom</span><span class="p">))</span>
<span class="k">GROUP</span> <span class="k">BY</span> <span class="k">c</span><span class="p">.</span><span class="n">id_commune</span><span class="p">,</span> <span class="k">c</span><span class="p">.</span><span class="n">nom</span><span class="p">,</span> <span class="k">c</span><span class="p">.</span><span class="n">code_insee</span>
<span class="p">;</span>
</code></pre></div>
</td></tr></table>
<p>C'est <strong>beaucoup plus long</strong>, car la requête n'utilise pas d'abord l'intersection, donc l'index spatial des communes, mais fait un parcours de toutes les lignes des communes, puis un calcul d'intersection. Pour accélérer la requête, on doit créer l'index sur les centroïdes des chemins</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="k">CREATE</span> <span class="k">INDEX</span> <span class="k">ON</span> <span class="n">z_formation</span><span class="p">.</span><span class="n">chemin</span> <span class="k">USING</span> <span class="n">GIST</span><span class="p">(</span><span class="n">ST_Centroid</span><span class="p">(</span><span class="n">geom</span><span class="p">))</span>
</code></pre></div>
</td></tr></table>
<p>puis la relancer. Dans cet exemple, on passe de 100 secondes à 1 seconde, grâce à ce nouvel index spatial.</p>
<h4 id="affiner-le-resultat-en-decoupant-les-chemins">Affiner le résultat en découpant les chemins<a class="headerlink" href="#affiner-le-resultat-en-decoupant-les-chemins" title="Permanent link">#</a></h4>
<p>Dans la requête précédente, on calculait la longueur totale de chaque chemin, pas le <strong>morceau exacte qui est sur chaque commune</strong>. Pour cela, on va utiliser la fonction <strong>ST_Intersection</strong>. La requête va être plus couteuse, car il faut réaliser le découpage des lignes des chemins par les polygones des communes.</p>
<p>On va découper exactement les chemins par commune et récupérer les informations</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">z_formation</span><span class="p">.</span><span class="n">decoupe_chemin_par_commune</span> <span class="k">AS</span>
<span class="c1">-- Découper les chemins par commune</span>
<span class="k">SELECT</span>
<span class="c1">-- id unique</span>
<span class="c1">-- infos du chemin</span>
<span class="n">l</span><span class="p">.</span><span class="n">id</span> <span class="k">AS</span> <span class="n">id_chemin</span><span class="p">,</span>
<span class="c1">-- infos de la commune</span>
<span class="k">c</span><span class="p">.</span><span class="n">nom</span><span class="p">,</span> <span class="k">c</span><span class="p">.</span><span class="n">code_insee</span><span class="p">,</span>
<span class="n">ST_Multi</span><span class="p">(</span><span class="n">st_collectionextract</span><span class="p">(</span><span class="n">ST_Intersection</span><span class="p">(</span><span class="k">c</span><span class="p">.</span><span class="n">geom</span><span class="p">,</span> <span class="n">l</span><span class="p">.</span><span class="n">geom</span><span class="p">),</span> <span class="mi">2</span><span class="p">))::</span><span class="n">geometry</span><span class="p">(</span><span class="n">multilinestring</span><span class="p">,</span> <span class="mi">2154</span><span class="p">)</span> <span class="k">AS</span> <span class="n">geom</span>
<span class="k">FROM</span> <span class="ss">&quot;z_formation&quot;</span><span class="p">.</span><span class="n">commune</span> <span class="k">AS</span> <span class="k">c</span>
<span class="k">JOIN</span> <span class="ss">&quot;z_formation&quot;</span><span class="p">.</span><span class="n">chemin</span> <span class="k">AS</span> <span class="n">l</span>
        <span class="k">ON</span> <span class="n">st_intersects</span><span class="p">(</span><span class="k">c</span><span class="p">.</span><span class="n">geom</span><span class="p">,</span> <span class="n">l</span><span class="p">.</span><span class="n">geom</span><span class="p">)</span>
<span class="p">;</span>
<span class="k">CREATE</span> <span class="k">INDEX</span> <span class="k">ON</span> <span class="n">z_formation</span><span class="p">.</span><span class="n">decoupe_chemin_par_commune</span> <span class="k">USING</span> <span class="n">GIST</span> <span class="p">(</span><span class="n">geom</span><span class="p">);</span>
</code></pre></div>
</td></tr></table>
<p><strong>NB</strong>: Attention à ne pas confondre <strong>ST_Intersects</strong> qui renvoit vrai ou faux, et <strong>ST_Intersection</strong> qui renvoit la géométrie issue du découpage d'une géométrie par une autre.</p>
<h3 id="joindre-des-polygones-avec-des-polygones">Joindre des polygones avec des polygones<a class="headerlink" href="#joindre-des-polygones-avec-des-polygones" title="Permanent link">#</a></h3>
<p>On peut bien sûr réaliser des <strong>jointures spatiales</strong> entre 2 couches de <strong>polygones</strong>, et découper les polygones par intersection. Attention, les performances sont forcément moins bonnes qu'avec des points.</p>
<p>Trouver l'ensemble des zonages PLU pour les parcelles du Havre.</p>
<p>On va récupérer <strong>plusieurs résultats pour chaque parcelle</strong> si plusieurs zonages chevauchent une parcelle.</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span>
<span class="normal">6</span>
<span class="normal">7</span>
<span class="normal">8</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="c1">-- Jointure spatiale</span>
<span class="k">SELECT</span>
<span class="n">p</span><span class="p">.</span><span class="n">id_parcelle</span><span class="p">,</span>
<span class="n">z</span><span class="p">.</span><span class="n">libelle</span><span class="p">,</span> <span class="n">z</span><span class="p">.</span><span class="n">libelong</span><span class="p">,</span> <span class="n">z</span><span class="p">.</span><span class="n">typezone</span>
<span class="k">FROM</span> <span class="n">z_formation</span><span class="p">.</span><span class="n">parcelle_havre</span> <span class="k">AS</span> <span class="n">p</span>
<span class="k">JOIN</span> <span class="n">z_formation</span><span class="p">.</span><span class="n">zone_urba</span> <span class="k">AS</span> <span class="n">z</span>
    <span class="k">ON</span> <span class="n">st_intersects</span><span class="p">(</span><span class="n">z</span><span class="p">.</span><span class="n">geom</span><span class="p">,</span> <span class="n">p</span><span class="p">.</span><span class="n">geom</span><span class="p">)</span>
<span class="k">WHERE</span> <span class="k">True</span>
</code></pre></div>
</td></tr></table>
<p>Compter pour chaque parcelle le nombre de zonages en intersection: on veut <strong>une seule ligne par parcelle</strong>.</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span>
<span class="normal">6</span>
<span class="normal">7</span>
<span class="normal">8</span>
<span class="normal">9</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="k">SELECT</span>
<span class="n">p</span><span class="p">.</span><span class="n">id_parcelle</span><span class="p">,</span>
<span class="k">count</span><span class="p">(</span><span class="n">z</span><span class="p">.</span><span class="n">libelle</span><span class="p">)</span> <span class="k">AS</span> <span class="n">nombre_zonage</span>
<span class="k">FROM</span> <span class="n">z_formation</span><span class="p">.</span><span class="n">parcelle_havre</span> <span class="k">AS</span> <span class="n">p</span>
<span class="k">JOIN</span> <span class="n">z_formation</span><span class="p">.</span><span class="n">zone_urba</span> <span class="k">AS</span> <span class="n">z</span>
    <span class="k">ON</span> <span class="n">st_intersects</span><span class="p">(</span><span class="n">z</span><span class="p">.</span><span class="n">geom</span><span class="p">,</span> <span class="n">p</span><span class="p">.</span><span class="n">geom</span><span class="p">)</span>
<span class="k">WHERE</span> <span class="k">True</span>
<span class="k">GROUP</span> <span class="k">BY</span> <span class="n">p</span><span class="p">.</span><span class="n">id_parcelle</span>
<span class="k">ORDER</span> <span class="k">BY</span> <span class="n">nombre_zonage</span> <span class="k">DESC</span>
</code></pre></div>
</td></tr></table>
<p>Découper les parcelles par les zonages, et pouvoir calculer les surfaces des zonages, et le pourcentage par rapport à la surface de chaque parcelle. On essaye le SQL suivant:</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="k">SELECT</span>
<span class="n">p</span><span class="p">.</span><span class="n">id_parcelle</span><span class="p">,</span>
<span class="n">z</span><span class="p">.</span><span class="n">libelle</span><span class="p">,</span> <span class="n">z</span><span class="p">.</span><span class="n">libelong</span><span class="p">,</span> <span class="n">z</span><span class="p">.</span><span class="n">typezone</span><span class="p">,</span>
<span class="c1">-- découper les géométries</span>
<span class="n">st_intersection</span><span class="p">(</span><span class="n">z</span><span class="p">.</span><span class="n">geom</span><span class="p">,</span> <span class="n">p</span><span class="p">.</span><span class="n">geom</span><span class="p">)</span> <span class="k">AS</span> <span class="n">geom</span>
<span class="k">FROM</span> <span class="n">z_formation</span><span class="p">.</span><span class="n">parcelle_havre</span> <span class="k">AS</span> <span class="n">p</span>
<span class="k">JOIN</span> <span class="n">z_formation</span><span class="p">.</span><span class="n">zone_urba</span> <span class="k">AS</span> <span class="n">z</span>
    <span class="k">ON</span> <span class="n">st_intersects</span><span class="p">(</span><span class="n">z</span><span class="p">.</span><span class="n">geom</span><span class="p">,</span> <span class="n">p</span><span class="p">.</span><span class="n">geom</span><span class="p">)</span>
<span class="k">WHERE</span> <span class="k">True</span>
<span class="k">ORDER</span> <span class="k">BY</span> <span class="n">p</span><span class="p">.</span><span class="n">id_parcelle</span>
</code></pre></div>
</td></tr></table>
<p>Il renvoit l'erreur</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code>ERREUR:  Error performing intersection: TopologyException: Input geom 1 is invalid: Self-intersection at or near point 492016.26000489673 6938870.663846286 at 492016.26000489673 6938870.663846286
</code></pre></div>
</td></tr></table>
<p>On a ici des soucis de <strong>validité de géométrie</strong>. Il nous faut donc corriger les géométries avant de poursuivre. Voir chapitre sur la validation des géométries.</p>
<p>Une fois les géométries validées, la requête fonctionne. On l'utilise dans une sous-requête pour créer une table et calculer les surfaces</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="c1">-- suppression de la table</span>
<span class="k">DROP</span> <span class="k">TABLE</span> <span class="k">IF</span> <span class="k">EXISTS</span> <span class="n">z_formation</span><span class="p">.</span><span class="n">decoupe_zonage_parcelle</span><span class="p">;</span>
<span class="c1">-- création de la table avec calcul de pourcentage de surface</span>
<span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">z_formation</span><span class="p">.</span><span class="n">decoupe_zonage_parcelle</span> <span class="k">AS</span>
<span class="k">SELECT</span> <span class="n">row_number</span><span class="p">()</span> <span class="n">OVER</span><span class="p">()</span> <span class="k">AS</span> <span class="n">id</span><span class="p">,</span>
<span class="k">source</span><span class="p">.</span><span class="o">*</span><span class="p">,</span>
<span class="n">ST_Area</span><span class="p">(</span><span class="n">geom</span><span class="p">)</span> <span class="k">AS</span> <span class="n">aire</span><span class="p">,</span>
<span class="mi">100</span> <span class="o">*</span> <span class="n">ST_Area</span><span class="p">(</span><span class="n">geom</span><span class="p">)</span> <span class="o">/</span> <span class="n">aire_parcelle</span> <span class="k">AS</span> <span class="n">pourcentage</span>
<span class="k">FROM</span> <span class="p">(</span>
<span class="k">SELECT</span>
        <span class="n">p</span><span class="p">.</span><span class="n">id_parcelle</span><span class="p">,</span> <span class="n">p</span><span class="p">.</span><span class="n">id</span> <span class="k">AS</span> <span class="n">idpar</span><span class="p">,</span> <span class="n">ST_Area</span><span class="p">(</span><span class="n">p</span><span class="p">.</span><span class="n">geom</span><span class="p">)</span> <span class="k">AS</span> <span class="n">aire_parcelle</span><span class="p">,</span>
        <span class="n">z</span><span class="p">.</span><span class="n">id_zone_urba</span><span class="p">,</span> <span class="n">z</span><span class="p">.</span><span class="n">libelle</span><span class="p">,</span> <span class="n">z</span><span class="p">.</span><span class="n">libelong</span><span class="p">,</span> <span class="n">z</span><span class="p">.</span><span class="n">typezone</span><span class="p">,</span>
        <span class="c1">-- découper les géométries</span>
        <span class="p">(</span><span class="n">ST_Multi</span><span class="p">(</span><span class="n">st_intersection</span><span class="p">(</span><span class="n">z</span><span class="p">.</span><span class="n">geom</span><span class="p">,</span> <span class="n">p</span><span class="p">.</span><span class="n">geom</span><span class="p">)))::</span><span class="n">geometry</span><span class="p">(</span><span class="n">MultiPolygon</span><span class="p">,</span><span class="mi">2154</span><span class="p">)</span> <span class="k">AS</span> <span class="n">geom</span>
        <span class="k">FROM</span> <span class="n">z_formation</span><span class="p">.</span><span class="n">parcelle_havre</span> <span class="k">AS</span> <span class="n">p</span>
        <span class="k">JOIN</span> <span class="n">z_formation</span><span class="p">.</span><span class="n">zone_urba</span> <span class="k">AS</span> <span class="n">z</span> <span class="k">ON</span> <span class="n">st_intersects</span><span class="p">(</span><span class="n">z</span><span class="p">.</span><span class="n">geom</span><span class="p">,</span> <span class="n">p</span><span class="p">.</span><span class="n">geom</span><span class="p">)</span>
        <span class="k">WHERE</span> <span class="k">True</span>
<span class="p">)</span> <span class="k">AS</span> <span class="k">source</span><span class="p">;</span>

<span class="c1">-- Ajout de la clé primaire</span>
<span class="k">ALTER</span> <span class="k">TABLE</span> <span class="n">z_formation</span><span class="p">.</span><span class="n">decoupe_zonage_parcelle</span> <span class="k">ADD</span> <span class="k">PRIMARY</span> <span class="k">KEY</span> <span class="p">(</span><span class="n">id</span><span class="p">);</span>

<span class="c1">-- Ajout de l&#39;index spatial</span>
<span class="k">CREATE</span> <span class="k">INDEX</span> <span class="k">ON</span> <span class="n">z_formation</span><span class="p">.</span><span class="n">decoupe_zonage_parcelle</span> <span class="k">USING</span> <span class="n">GIST</span> <span class="p">(</span><span class="n">geom</span><span class="p">);</span>
</code></pre></div>
</td></tr></table>
<h3 id="faire-un-rapport-des-surfaces-intersectees-de-zonages-sur-une-table-principale">Faire un rapport des surfaces intersectées de zonages sur une table principale<a class="headerlink" href="#faire-un-rapport-des-surfaces-intersectees-de-zonages-sur-une-table-principale" title="Permanent link">#</a></h3>
<p>Par exemple, pour chacune des communes, on souhaite calculer la somme des surfaces intersectée par chaque type de zone (parcs, znieff, etc.).</p>
<p>Afin d'avoir à disposition des données de test pour cet exemple de rapport, nous allons créer 2 tables <code>z_formation.parc_national</code> et <code>z_formation.znieff</code>, et y insérer des fausses données:</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="c1">-- Table des parcs nationaux</span>
<span class="k">CREATE</span> <span class="k">TABLE</span> <span class="k">IF</span> <span class="k">NOT</span> <span class="k">EXISTS</span> <span class="n">z_formation</span><span class="p">.</span><span class="n">parc_national</span> <span class="p">(</span>
    <span class="n">id</span> <span class="nb">serial</span> <span class="k">primary</span> <span class="k">key</span><span class="p">,</span>
    <span class="n">nom</span> <span class="nb">text</span><span class="p">,</span>
    <span class="n">geom</span> <span class="n">geometry</span><span class="p">(</span><span class="n">multipolygon</span><span class="p">,</span> <span class="mi">2154</span><span class="p">)</span>
<span class="p">);</span>
<span class="k">CREATE</span> <span class="k">INDEX</span> <span class="k">ON</span> <span class="n">z_formation</span><span class="p">.</span><span class="n">parc_national</span> <span class="k">USING</span> <span class="n">GIST</span> <span class="p">(</span><span class="n">geom</span><span class="p">);</span>

<span class="c1">-- Table des znieff</span>
<span class="k">CREATE</span> <span class="k">TABLE</span> <span class="k">IF</span> <span class="k">NOT</span> <span class="k">EXISTS</span> <span class="n">z_formation</span><span class="p">.</span><span class="n">znieff</span><span class="p">(</span>
    <span class="n">id</span> <span class="nb">serial</span> <span class="k">primary</span> <span class="k">key</span><span class="p">,</span>
    <span class="n">nom_znieff</span> <span class="nb">text</span><span class="p">,</span>
    <span class="n">geom</span> <span class="n">geometry</span><span class="p">(</span><span class="n">multipolygon</span><span class="p">,</span> <span class="mi">2154</span><span class="p">)</span>
<span class="p">);</span>
<span class="k">CREATE</span> <span class="k">INDEX</span> <span class="k">ON</span> <span class="n">z_formation</span><span class="p">.</span><span class="n">znieff</span> <span class="k">USING</span> <span class="n">GIST</span> <span class="p">(</span><span class="n">geom</span><span class="p">);</span>
</code></pre></div>
</td></tr></table>
<p>On insère des polygones dans ces deux tables:</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="c1">-- données de test</span>
<span class="c1">-- parcs</span>
<span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">z_formation</span><span class="p">.</span><span class="n">parc_national</span> <span class="k">VALUES</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;un&#39;</span><span class="p">,</span> <span class="s1">&#39;01060000206A0800000100000001030000000100000008000000C3F7DE73553D20411B3DC1FB0C625A410531F757E93D2041BAECB21FA85E5A41F35B09978081204195F05B9787595A41D61E4865A1A7204147BC8A3AC0605A41ED76A806317F2041A79F7E4876605A41B80752433C832041037846623A655A41E10ED595BA6120413CC1D1C18C685A41C3F7DE73553D20411B3DC1FB0C625A41&#39;</span><span class="p">);</span>
<span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">z_formation</span><span class="p">.</span><span class="n">parc_national</span> <span class="k">VALUES</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;deux&#39;</span><span class="p">,</span> <span class="s1">&#39;01060000206A080000010000000103000000010000000900000024D68B4AE0412141AAAAAA3C685B5A4130642ACBD01421413A85AE4B72585A41CA08F0240E382141746C4BD107535A41FA30F7A78A4A2141524A29E544555A414796BF5CE63621414DD2E222A4565A416B92160F9B5D2141302807F981575A4130DC700B2E782141DC0ED50B6B5C5A4106FBB8C8294F214150AC17BF015E5A4124D68B4AE0412141AAAAAA3C685B5A41&#39;</span><span class="p">);</span>
<span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">z_formation</span><span class="p">.</span><span class="n">parc_national</span> <span class="k">VALUES</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="s1">&#39;trois&#39;</span><span class="p">,</span> <span class="s1">&#39;01060000206A0800000100000001030000000100000006000000918DCFE7E0861F4137AB79AF14515A411AE56040588A1F41642A43EEC74F5A41DF2EBB3CEBA41F418C31C66ADA4F5A4168864C9562A81F416E87EA40B8505A415CBC8A74C3A31F410FA4F63202515A41918DCFE7E0861F4137AB79AF14515A41&#39;</span><span class="p">);</span>
<span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">z_formation</span><span class="p">.</span><span class="n">parc_national</span> <span class="k">VALUES</span> <span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="s1">&#39;quatre&#39;</span><span class="p">,</span> <span class="s1">&#39;01060000206A080000010000000103000000010000000500000004474FE81DBA2041269A684EFD625A41AB17C51223C9204120B507BEAD605A4116329539BBF22041A3273886D5615A416F611F0FB6E32041FA1A9F0F4A645A4104474FE81DBA2041269A684EFD625A41&#39;</span><span class="p">);</span>
<span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">z_formation</span><span class="p">.</span><span class="n">parc_national</span> <span class="k">VALUES</span> <span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="s1">&#39;cinq&#39;</span><span class="p">,</span> <span class="s1">&#39;01060000206A0800000100000001030000000100000005000000F2E3C256231E2041E0ACE631AE535A41F7C823E772202041E89C73B6EF505A41B048BCC266362041DAC785A15E515A419E999911782F204180C9F223F8535A41F2E3C256231E2041E0ACE631AE535A41&#39;</span><span class="p">);</span>
<span class="k">SELECT</span> <span class="n">pg_catalog</span><span class="p">.</span><span class="n">setval</span><span class="p">(</span><span class="s1">&#39;z_formation.parc_national_id_seq&#39;</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="k">true</span><span class="p">);</span>

<span class="c1">-- znieff</span>
<span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">z_formation</span><span class="p">.</span><span class="n">znieff</span> <span class="k">VALUES</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;uno&#39;</span><span class="p">,</span> <span class="s1">&#39;01060000206A08000001000000010300000001000000050000004039188C39D12041770A5DF74A4A5A413A54B7FBE9CE20410C5DA7C8F5455A41811042C0A4EA204130ECE38267475A416F611F0FB6E320417125FC66FB475A414039188C39D12041770A5DF74A4A5A41&#39;</span><span class="p">);</span>
<span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">z_formation</span><span class="p">.</span><span class="n">znieff</span> <span class="k">VALUES</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;dos&#39;</span><span class="p">,</span> <span class="s1">&#39;01060000206A080000010000000103000000010000000500000076BEC6DF62492141513FFDF0525A5A417CA32770B24B21411EDBD22150595A419437ABB1F05421410F06E50CBF595A419437ABB1F0542141B022F1FE085A5A4176BEC6DF62492141513FFDF0525A5A41&#39;</span><span class="p">);</span>
<span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">z_formation</span><span class="p">.</span><span class="n">znieff</span> <span class="k">VALUES</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="s1">&#39;tres&#39;</span><span class="p">,</span> <span class="s1">&#39;01060000206A0800000100000001030000000100000005000000A6E6CD62DF5B2141B607528F585C5A41ACCB2EF32E5E2141C5DC3FA4E95B5A414CB7438DE46A2141C5DC3FA4E95B5A41B895F013CE62214189888850A55D5A41A6E6CD62DF5B2141B607528F585C5A41&#39;</span><span class="p">);</span>
<span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">z_formation</span><span class="p">.</span><span class="n">znieff</span> <span class="k">VALUES</span> <span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="s1">&#39;quatro&#39;</span><span class="p">,</span> <span class="s1">&#39;01060000206A0800000100000001030000000100000005000000CE857DF445102041985D7665365D5A41DA4F3F15E5142041339521C7305B5A41C2F7DE73553D2041927815D5E65A5A410393E50712252041B607528F585C5A41CE857DF445102041985D7665365D5A41&#39;</span><span class="p">);</span>
<span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">z_formation</span><span class="p">.</span><span class="n">znieff</span> <span class="k">VALUES</span> <span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="s1">&#39;cinco&#39;</span><span class="p">,</span> <span class="s1">&#39;01060000206A080000010000000103000000010000000500000045A632DC2B702041FD25CB033C5F5A41CEFDC334A373204115EB459D0E5C5A41F25B099780812041397A8257805D5A415755558D1A7720419E42D7F5855F5A4145A632DC2B702041FD25CB033C5F5A41&#39;</span><span class="p">);</span>
<span class="k">SELECT</span> <span class="n">pg_catalog</span><span class="p">.</span><span class="n">setval</span><span class="p">(</span><span class="s1">&#39;z_formation.znieff_id_seq&#39;</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="k">true</span><span class="p">);</span>
</code></pre></div>
</td></tr></table>
<p>Pour chaque commune, on souhaite calculer la somme des surfaces intersectée par chaque type de zone. On doit donc utiliser toutes les tables de zonage (ici seulement 2 tables, mais c'est possible d'en ajouter)</p>
<ul>
<li>Méthode avec des <strong>jointures LEFT</strong></li>
</ul>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="k">SELECT</span>
    <span class="c1">-- champs choisis dans la table commune</span>
    <span class="k">c</span><span class="p">.</span><span class="n">id_commune</span><span class="p">,</span> <span class="k">c</span><span class="p">.</span><span class="n">code_insee</span><span class="p">,</span> <span class="k">c</span><span class="p">.</span><span class="n">nom</span><span class="p">,</span>
    <span class="c1">-- surface en ha</span>
    <span class="n">ST_Area</span><span class="p">(</span><span class="k">c</span><span class="p">.</span><span class="n">geom</span><span class="p">)</span> <span class="o">/</span> <span class="mi">10000</span> <span class="k">AS</span> <span class="n">surface_commune_ha</span><span class="p">,</span>
    <span class="c1">-- somme des découpages des parcs par commune</span>
    <span class="k">sum</span><span class="p">(</span><span class="n">ST_Area</span><span class="p">(</span><span class="n">ST_Intersection</span><span class="p">(</span><span class="k">c</span><span class="p">.</span><span class="n">geom</span><span class="p">,</span> <span class="n">p</span><span class="p">.</span><span class="n">geom</span><span class="p">))</span> <span class="o">/</span> <span class="mi">10000</span> <span class="p">)</span> <span class="k">AS</span> <span class="n">somme_surface_parcs</span><span class="p">,</span>
    <span class="c1">-- somme des découpages des znieff par commune</span>
    <span class="k">sum</span><span class="p">(</span><span class="n">ST_Area</span><span class="p">(</span><span class="n">ST_Intersection</span><span class="p">(</span><span class="k">c</span><span class="p">.</span><span class="n">geom</span><span class="p">,</span> <span class="n">z</span><span class="p">.</span><span class="n">geom</span><span class="p">))</span> <span class="o">/</span> <span class="mi">10000</span> <span class="p">)</span> <span class="k">AS</span> <span class="n">somme_surface_znieff</span>

<span class="k">FROM</span> <span class="n">z_formation</span><span class="p">.</span><span class="n">commune</span> <span class="k">AS</span> <span class="k">c</span>
<span class="c1">-- jointure spatiale sur les parcs</span>
<span class="k">LEFT</span> <span class="k">JOIN</span> <span class="n">z_formation</span><span class="p">.</span><span class="n">parc_national</span> <span class="k">AS</span> <span class="n">p</span>
    <span class="k">ON</span> <span class="n">ST_Intersects</span><span class="p">(</span><span class="k">c</span><span class="p">.</span><span class="n">geom</span><span class="p">,</span> <span class="n">p</span><span class="p">.</span><span class="n">geom</span><span class="p">)</span>
<span class="c1">-- jointure spatiale sur les znieff</span>
<span class="k">LEFT</span> <span class="k">JOIN</span> <span class="n">z_formation</span><span class="p">.</span><span class="n">znieff</span> <span class="k">AS</span> <span class="n">z</span>
    <span class="k">ON</span> <span class="n">ST_Intersects</span><span class="p">(</span><span class="k">c</span><span class="p">.</span><span class="n">geom</span><span class="p">,</span> <span class="n">z</span><span class="p">.</span><span class="n">geom</span><span class="p">)</span>

<span class="c1">-- clause WHERE optionelle</span>
<span class="c1">-- WHERE p.id IS NOT NULL OR z.id IS NOT NULL</span>

<span class="c1">-- on regroupe sur les champs des communes</span>
<span class="k">GROUP</span> <span class="k">BY</span> <span class="k">c</span><span class="p">.</span><span class="n">id_commune</span><span class="p">,</span> <span class="k">c</span><span class="p">.</span><span class="n">code_insee</span><span class="p">,</span> <span class="k">c</span><span class="p">.</span><span class="n">nom</span>

<span class="c1">-- on ordonne par nom</span>
<span class="k">ORDER</span> <span class="k">BY</span> <span class="k">c</span><span class="p">.</span><span class="n">nom</span>
</code></pre></div>
</td></tr></table>
<p>Avantage: on peut intégrer facilement dans la clause WHERE des conditions sur les champs des tables jointes. Par exemple ne récupérer que les lignes qui sont concernées par un parc ou une znieff, via <code>WHERE p.id IS NOT NULL OR z.id IS NOT NULL</code> (commenté ci-dessus pour le désactiver)</p>
<p>Résultat:</p>
<table>
<thead>
<tr>
<th>id_commune</th>
<th>code_insee</th>
<th>nom</th>
<th>surface_commune_ha</th>
<th>somme_surface_parcs</th>
<th>somme_surface_znieff</th>
</tr>
</thead>
<tbody>
<tr>
<td>1139</td>
<td>27042</td>
<td>Barville</td>
<td>275.138028733401</td>
<td>87.2237204013011</td>
<td>None</td>
</tr>
<tr>
<td>410</td>
<td>27057</td>
<td>Bernienville</td>
<td>779.74546553394</td>
<td>None</td>
<td>5.26504189468878</td>
</tr>
<tr>
<td>1193</td>
<td>27061</td>
<td>Berthouville</td>
<td>757.19696570046</td>
<td>19.9975421896336</td>
<td>None</td>
</tr>
<tr>
<td>495</td>
<td>27074</td>
<td>Boisney</td>
<td>576.995877227961</td>
<td>0.107059260396721</td>
<td>None</td>
</tr>
<tr>
<td>432</td>
<td>27077</td>
<td>Boissey-le-Châtel</td>
<td>438.373848703835</td>
<td>434.510197417769</td>
<td>83.9289621127432</td>
</tr>
</tbody>
</table>
<ul>
<li>Méthode avec des sous-requêtes</li>
</ul>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span>
<span class="normal">6</span>
<span class="normal">7</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="k">SELECT</span>
    <span class="k">c</span><span class="p">.</span><span class="n">id_commune</span><span class="p">,</span> <span class="k">c</span><span class="p">.</span><span class="n">code_insee</span><span class="p">,</span> <span class="k">c</span><span class="p">.</span><span class="n">nom</span><span class="p">,</span>
    <span class="n">ST_Area</span><span class="p">(</span><span class="k">c</span><span class="p">.</span><span class="n">geom</span><span class="p">)</span> <span class="o">/</span> <span class="mi">10000</span> <span class="k">AS</span> <span class="n">surface_commune_ha</span><span class="p">,</span>
    <span class="p">(</span><span class="k">SELECT</span> <span class="k">sum</span><span class="p">(</span><span class="n">ST_Area</span><span class="p">(</span><span class="n">ST_Intersection</span><span class="p">(</span><span class="k">c</span><span class="p">.</span><span class="n">geom</span><span class="p">,</span> <span class="n">p</span><span class="p">.</span><span class="n">geom</span><span class="p">))</span> <span class="o">/</span> <span class="mi">10000</span> <span class="p">)</span> <span class="k">FROM</span> <span class="n">z_formation</span><span class="p">.</span><span class="n">parc_national</span> <span class="k">AS</span> <span class="n">p</span> <span class="k">WHERE</span> <span class="n">ST_Intersects</span><span class="p">(</span><span class="n">p</span><span class="p">.</span><span class="n">geom</span><span class="p">,</span> <span class="k">c</span><span class="p">.</span><span class="n">geom</span><span class="p">)</span> <span class="p">)</span> <span class="k">AS</span> <span class="n">surface_parc_national</span><span class="p">,</span>
    <span class="p">(</span><span class="k">SELECT</span> <span class="k">sum</span><span class="p">(</span><span class="n">ST_Area</span><span class="p">(</span><span class="n">ST_Intersection</span><span class="p">(</span><span class="k">c</span><span class="p">.</span><span class="n">geom</span><span class="p">,</span> <span class="n">p</span><span class="p">.</span><span class="n">geom</span><span class="p">))</span> <span class="o">/</span> <span class="mi">10000</span> <span class="p">)</span> <span class="k">FROM</span> <span class="n">z_formation</span><span class="p">.</span><span class="n">znieff</span> <span class="k">AS</span> <span class="n">p</span> <span class="k">WHERE</span> <span class="n">ST_Intersects</span><span class="p">(</span><span class="n">p</span><span class="p">.</span><span class="n">geom</span><span class="p">,</span> <span class="k">c</span><span class="p">.</span><span class="n">geom</span><span class="p">)</span> <span class="p">)</span> <span class="k">AS</span> <span class="n">surface_znieff</span>
<span class="k">FROM</span> <span class="n">z_formation</span><span class="p">.</span><span class="n">commune</span> <span class="k">AS</span> <span class="k">c</span>
<span class="k">ORDER</span> <span class="k">BY</span> <span class="k">c</span><span class="p">.</span><span class="n">nom</span>
</code></pre></div>
</td></tr></table>
<p>Avantage: plus simple à écrire, mais ne permet pas de clause WHERE simple</p>
<p><strong>ATTENTION</strong>:</p>
<ul>
<li>il faut absolument avoir un index spatial sur le champ <code>geom</code> de toutes les tables</li>
<li>le calcul de découpage des polygones des communes par ceux des zonages peut être très long (et l'index spatial ne sert à rien ici)</li>
</ul>
<h3 id="distances-et-tampons-entre-couches">Distances et tampons entre couches<a class="headerlink" href="#distances-et-tampons-entre-couches" title="Permanent link">#</a></h3>
<p>Pour chaque objets d'une table, on souhaite récupéerer des informations sur les<strong> objets proches d'une autre table</strong>. Au lieu d'utiliser un tampon puis une intersection, on utilise la fonction <strong>ST_DWithin</strong></p>
<p>On prend comme exemple la table des bornes à incendie créée précédememnt (remplie avec quelques données de test).</p>
<p>Trouver toutes les parcelles <strong>à moins de 200m</strong> d'une borne à incendie</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span>
<span class="normal">6</span>
<span class="normal">7</span>
<span class="normal">8</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="k">SELECT</span>
<span class="n">p</span><span class="p">.</span><span class="n">id_parcelle</span><span class="p">,</span> <span class="n">p</span><span class="p">.</span><span class="n">geom</span><span class="p">,</span>
<span class="n">b</span><span class="p">.</span><span class="n">id_borne</span><span class="p">,</span> <span class="n">b</span><span class="p">.</span><span class="n">code</span><span class="p">,</span>
<span class="n">ST_Distance</span><span class="p">(</span><span class="n">b</span><span class="p">.</span><span class="n">geom</span><span class="p">,</span> <span class="n">p</span><span class="p">.</span><span class="n">geom</span><span class="p">)</span> <span class="k">AS</span> <span class="n">distance</span>
<span class="k">FROM</span> <span class="n">z_formation</span><span class="p">.</span><span class="n">parcelle_havre</span> <span class="k">AS</span> <span class="n">p</span>
<span class="k">JOIN</span> <span class="n">z_formation</span><span class="p">.</span><span class="n">borne_incendie</span> <span class="k">AS</span> <span class="n">b</span>
        <span class="k">ON</span> <span class="n">ST_DWithin</span><span class="p">(</span><span class="n">p</span><span class="p">.</span><span class="n">geom</span><span class="p">,</span> <span class="n">b</span><span class="p">.</span><span class="n">geom</span><span class="p">,</span> <span class="mi">200</span><span class="p">)</span>
<span class="k">ORDER</span> <span class="k">BY</span> <span class="n">id_parcelle</span><span class="p">,</span> <span class="n">id_borne</span>
</code></pre></div>
</td></tr></table>
<p>Attention, elle peut renvoyer <strong>plusieurs fois la même parcelle</strong> si 2 bornes sont assez proches. Pour ne récupérer que la borne la plus proche, on peut faire la requête suivante. La clause <strong>DISTINCT ON</strong> permet de dire quel champ doit être <strong>unique</strong> (ici id_parcelle).</p>
<p>On <strong>ordonne</strong> ensuite <strong>par ce champ et par la distance</strong> pour prendre seulement la ligne correspondant à la parcelle <strong>la plus proche</strong></p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span>
<span class="normal">6</span>
<span class="normal">7</span>
<span class="normal">8</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="k">SELECT</span> <span class="k">DISTINCT</span> <span class="k">ON</span> <span class="p">(</span><span class="n">p</span><span class="p">.</span><span class="n">id_parcelle</span><span class="p">)</span>
<span class="n">p</span><span class="p">.</span><span class="n">id_parcelle</span><span class="p">,</span> <span class="n">p</span><span class="p">.</span><span class="n">geom</span><span class="p">,</span>
<span class="n">b</span><span class="p">.</span><span class="n">id_borne</span><span class="p">,</span> <span class="n">b</span><span class="p">.</span><span class="n">code</span><span class="p">,</span>
<span class="n">ST_Distance</span><span class="p">(</span><span class="n">b</span><span class="p">.</span><span class="n">geom</span><span class="p">,</span> <span class="n">p</span><span class="p">.</span><span class="n">geom</span><span class="p">)</span> <span class="k">AS</span> <span class="n">distance</span>
<span class="k">FROM</span> <span class="n">z_formation</span><span class="p">.</span><span class="n">parcelle_havre</span> <span class="k">AS</span> <span class="n">p</span>
<span class="k">JOIN</span> <span class="n">z_formation</span><span class="p">.</span><span class="n">borne_incendie</span> <span class="k">AS</span> <span class="n">b</span>
        <span class="k">ON</span> <span class="n">ST_DWithin</span><span class="p">(</span><span class="n">p</span><span class="p">.</span><span class="n">geom</span><span class="p">,</span> <span class="n">b</span><span class="p">.</span><span class="n">geom</span><span class="p">,</span> <span class="mi">200</span><span class="p">)</span>
<span class="k">ORDER</span> <span class="k">BY</span> <span class="n">id_parcelle</span><span class="p">,</span> <span class="n">distance</span>
</code></pre></div>
</td></tr></table>
<p>Pour information, on peut vérifier en créant les tampons</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span>
<span class="normal">6</span>
<span class="normal">7</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="c1">-- Tampons non dissous</span>
<span class="k">SELECT</span> <span class="n">id_borne</span><span class="p">,</span> <span class="n">ST_Buffer</span><span class="p">(</span><span class="n">geom</span><span class="p">,</span> <span class="mi">200</span><span class="p">)</span> <span class="k">AS</span> <span class="n">geom</span>
<span class="k">FROM</span> <span class="n">z_formation</span><span class="p">.</span><span class="n">borne_incendie</span>

<span class="c1">-- Tampons dissous</span>
<span class="k">SELECT</span> <span class="n">ST_Union</span><span class="p">(</span><span class="n">ST_Buffer</span><span class="p">(</span><span class="n">geom</span><span class="p">,</span> <span class="mi">200</span><span class="p">))</span> <span class="k">AS</span> <span class="n">geom</span>
<span class="k">FROM</span> <span class="n">z_formation</span><span class="p">.</span><span class="n">borne_incendie</span>
</code></pre></div>
</td></tr></table>
<p>Continuer vers <a href="../merge_geometries/">Fusionner des géométries</a></p>
                
              
              
                


              
            </article>
          </div>
        </div>
        
          <a href="#" class="md-top md-icon" data-md-component="top" data-md-state="hidden">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12z"/></svg>
            Back to top
          </a>
        
      </main>
      
        
<footer class="md-footer">
  
    <nav class="md-footer__inner md-grid" aria-label="Footer">
      
        
        <a href="../save_queries/" class="md-footer__link md-footer__link--prev" aria-label="Previous: Enregistrer" rel="prev">
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
          </div>
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Previous
              </span>
              Enregistrer
            </div>
          </div>
        </a>
      
      
        
        <a href="../merge_geometries/" class="md-footer__link md-footer__link--next" aria-label="Next: Fusionner" rel="next">
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Next
              </span>
              Fusionner
            </div>
          </div>
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4z"/></svg>
          </div>
        </a>
      
    </nav>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
          <div class="md-footer-copyright__highlight">
            <span class="copyleft">&copy;</span> 3Liz
          </div>
        
        Made with
        <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
          Material for MkDocs
        </a>
        
      </div>
      
  <div class="md-footer-social">
    
      
      
        
        
      
      <a href="https://twitter.com/3LIZ_news" target="_blank" rel="noopener" title="twitter.com" class="md-footer-social__link">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M459.37 151.716c.325 4.548.325 9.097.325 13.645 0 138.72-105.583 298.558-298.558 298.558-59.452 0-114.68-17.219-161.137-47.106 8.447.974 16.568 1.299 25.34 1.299 49.055 0 94.213-16.568 130.274-44.832-46.132-.975-84.792-31.188-98.112-72.772 6.498.974 12.995 1.624 19.818 1.624 9.421 0 18.843-1.3 27.614-3.573-48.081-9.747-84.143-51.98-84.143-102.985v-1.299c13.969 7.797 30.214 12.67 47.431 13.319-28.264-18.843-46.781-51.005-46.781-87.391 0-19.492 5.197-37.36 14.294-52.954 51.655 63.675 129.3 105.258 216.365 109.807-1.624-7.797-2.599-15.918-2.599-24.04 0-57.828 46.782-104.934 104.934-104.934 30.213 0 57.502 12.67 76.67 33.137 23.715-4.548 46.456-13.32 66.599-25.34-7.798 24.366-24.366 44.833-46.132 57.827 21.117-2.273 41.584-8.122 60.426-16.243-14.292 20.791-32.161 39.308-52.628 54.253z"/></svg>
      </a>
    
      
      
        
        
      
      <a href="https://www.linkedin.com/company/3liz" target="_blank" rel="noopener" title="www.linkedin.com" class="md-footer-social__link">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M416 32H31.9C14.3 32 0 46.5 0 64.3v383.4C0 465.5 14.3 480 31.9 480H416c17.6 0 32-14.5 32-32.3V64.3c0-17.8-14.4-32.3-32-32.3zM135.4 416H69V202.2h66.5V416zm-33.2-243c-21.3 0-38.5-17.3-38.5-38.5S80.9 96 102.2 96c21.2 0 38.5 17.3 38.5 38.5 0 21.3-17.2 38.5-38.5 38.5zm282.1 243h-66.4V312c0-24.8-.5-56.7-34.5-56.7-34.6 0-39.9 27-39.9 54.9V416h-66.4V202.2h63.7v29.2h.9c8.9-16.8 30.6-34.5 62.9-34.5 67.2 0 79.7 44.3 79.7 101.9V416z"/></svg>
      </a>
    
      
      
        
        
      
      <a href="https://github.com/3liz/" target="_blank" rel="noopener" title="github.com" class="md-footer-social__link">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg>
      </a>
    
      
      
        
        
      
      <a href="https://hub.docker.com/u/3liz" target="_blank" rel="noopener" title="hub.docker.com" class="md-footer-social__link">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 512"><path d="M349.9 236.3h-66.1v-59.4h66.1v59.4zm0-204.3h-66.1v60.7h66.1V32zm78.2 144.8H362v59.4h66.1v-59.4zm-156.3-72.1h-66.1v60.1h66.1v-60.1zm78.1 0h-66.1v60.1h66.1v-60.1zm276.8 100c-14.4-9.7-47.6-13.2-73.1-8.4-3.3-24-16.7-44.9-41.1-63.7l-14-9.3-9.3 14c-18.4 27.8-23.4 73.6-3.7 103.8-8.7 4.7-25.8 11.1-48.4 10.7H2.4c-8.7 50.8 5.8 116.8 44 162.1 37.1 43.9 92.7 66.2 165.4 66.2 157.4 0 273.9-72.5 328.4-204.2 21.4.4 67.6.1 91.3-45.2 1.5-2.5 6.6-13.2 8.5-17.1l-13.3-8.9zm-511.1-27.9h-66v59.4h66.1v-59.4zm78.1 0h-66.1v59.4h66.1v-59.4zm78.1 0h-66.1v59.4h66.1v-59.4zm-78.1-72.1h-66.1v60.1h66.1v-60.1z"/></svg>
      </a>
    
  </div>

    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    <script id="__config" type="application/json">{"base": "..", "features": ["navigation.tabs.sticky", "navigation.top"], "translations": {"clipboard.copy": "Copy to clipboard", "clipboard.copied": "Copied to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.placeholder": "Type to start searching", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.term.missing": "Missing", "select.version.title": "Select version"}, "search": "../assets/javascripts/workers/search.477d984a.min.js", "version": null}</script>
    
    
      <script src="../assets/javascripts/bundle.ddd52ceb.min.js"></script>
      
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.1.1/highlight.min.js"></script>
      
        <script src="https://unpkg.com/mermaid@8.6.4/dist/mermaid.min.js"></script>
      
    
  </body>
</html>